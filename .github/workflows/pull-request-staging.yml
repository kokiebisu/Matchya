name: PR Pipeline (Staging)

on:
  pull_request:
    branches:
      - staging
    types:
      - opened
      - reopened
      - synchronize
      - edited

jobs:
  plan-infrastructure-shared:
    name: Plan
    uses: ./.github/workflows/job-plan-infrastructure.yml
    with:
      environment: staging
      component: shared
      label: Shared Infrastructure
    secrets: inherit

  plan-terraform-environment:
    name: Plan
    needs: [plan-infrastructure-shared]
    uses: ./.github/workflows/job-plan-infrastructure.yml
    with:
      environment: staging
      component: environment
      label: Environment Infrastructure
    secrets: inherit

  automated-tests:
    name: Automated Tests
    runs-on: ubuntu-latest
    needs: [plan-terraform-environment]
    strategy:
      matrix:
        component:
          ["authentication", "authorizer", "checklist", "company", "position"]
    steps:
      - uses: actions/checkout@v3

      - name: Check Web Files Changed
        uses: dorny/paths-filter@v2
        if: matrix.component == 'web'
        id: changes-web
        with:
          filters: |
            package:
              - '${{matrix.component}}/**'

      - name: Check Files Changed (Lambdas)
        uses: dorny/paths-filter@v2
        if: matrix.component != 'web'
        id: changes-lambda
        with:
          filters: |
            package:
              - 'lambdas/${{matrix.component}}/**'

      - name: Run (${{matrix.component}})
        if: matrix.component == 'web' && steps.changes-web.outputs.package == 'true'
        run: echo "Running automated tests..."
        working-directory: ${{matrix.component}}

      - name: Run (${{matrix.component}})
        if: matrix.component != 'web' && steps.changes-lambda.outputs.package == 'true'
        run: echo "Running automated tests..."
        working-directory: lambdas/${{matrix.component}}
